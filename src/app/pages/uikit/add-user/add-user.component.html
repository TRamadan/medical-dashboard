<p-toast></p-toast>

<p-toolbar styleClass="mb-6">
    <ng-template #start>
        <p-button icon="pi pi-plus" raised label="New" class="mr-2" (onClick)="openAddUserDialog()" />
    </ng-template>

    <ng-template #end>
        <p-button label="Export" icon="pi pi-upload" severity="secondary" />
    </ng-template>
</p-toolbar>

<p-card>
    <div class="flex items-center justify-between mb-2">
        <h5 class="m-0">Manage users</h5>
    </div>

    <app-table [headers]="coachsHeader" [data]="allUsers" [paginator]="true" [rows]="10" [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]" [showGlobalFilter]="true" [globalFilterPlaceholder]="'Search...'"
        [showActions]="true" (edit)="editSelectedUser($event)" (delete)="deleteSelectedUser($event)">
        <ng-template pTemplate="actions" let-rowData>
            <button pButton pRipple icon="pi pi-eye" class="p-button-rounded p-button-info mr-2"
                (click)="showUserDetails(rowData)"></button>
        </ng-template>
    </app-table>
</p-card>

<!-- here is the dialog neede0d to add a new user or customer-->
<p-dialog [(visible)]="userDialog" [header]="isEdit ? 'Update selected user' : 'Add new user'" [modal]="true"
    [dismissableMask]="true" styleClass="p-fluid" [style]="{ width: '90vw', maxWidth: '60rem' }">

    @if(!isDelete){
    <form [formGroup]="addNewUserForm">
        <p-stepper [value]="1" class="basis-[50rem]">
            <p-step-list>
                <p-step [value]="1">Personal Information</p-step>
                <p-step [value]="2">Employeement Information</p-step>
            </p-step-list>
            <p-step-panels>
                <p-step-panel [value]="1">
                    <ng-template #content let-activateCallback="activateCallback">
                        <div class="container-fluid">
                            <div formGroupName="personalData" class="row mt-3">
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" id="userName" formControlName="userName" class="form-control"
                                            placeholder="Username" />
                                        <label for="userName">Username</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" id="nameAr" formControlName="nameAr" class="form-control"
                                            placeholder="Name (Arabic)" />
                                        <label for="nameAr">Name (Arabic)</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" id="nameEn" formControlName="nameEn" class="form-control"
                                            placeholder="Name (English)" />
                                        <label for="nameEn">Name (English)</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="email" id="email" formControlName="email" class="form-control"
                                            placeholder="Email" />
                                        <label for="email">Email</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="tel" id="phoneNumber" formControlName="phoneNumber"
                                            class="form-control" placeholder="Phone Number" />
                                        <label for="phoneNumber">Phone Number</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="password" id="password" formControlName="password"
                                            class="form-control" placeholder="Password" />
                                        <label for="password">Password</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="rolesId" class="form-label">Roles</label>
                                    <p-multiSelect id="rolesId" formControlName="rolesId" [options]="allRoles"
                                        optionLabel="label" optionValue="value" placeholder="Select Roles"
                                        styleClass="w-full"></p-multiSelect>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="groupesId" class="form-label">Groups</label>
                                    <p-multiSelect id="groupesId" formControlName="groupesId" [options]="allGroups"
                                        optionLabel="label" optionValue="value" placeholder="Select Groups"
                                        styleClass="w-full"></p-multiSelect>
                                </div>
                            </div>
                        </div>
                        <div class="flex pt-4 justify-end">
                            <p-button label="Next" icon="pi pi-arrow-right" iconPos="right"
                                (onClick)="activateCallback(2)" />
                        </div>
                    </ng-template>
                </p-step-panel>

                <p-step-panel [value]="2">
                    <ng-template #content let-activateCallback="activateCallback">
                        <div class="container-fluid">
                            <div formGroupName="employeeData" class="row mt-3">
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" id="fullNameAr" formControlName="fullNameAr"
                                            class="form-control" placeholder="Full Name (Arabic)" />
                                        <label for="fullNameAr">Full Name (Arabic)</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" id="fullNameEn" formControlName="fullNameEn"
                                            class="form-control" placeholder="Full Name (English)" />
                                        <label for="fullNameEn">Full Name (English)</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="tel" id="whatsappNumber" formControlName="whatsappNumber"
                                            class="form-control" placeholder="WhatsApp Number" />
                                        <label for="whatsappNumber">WhatsApp Number</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="tel" id="argentNumber1" formControlName="argentNumber1"
                                            class="form-control" placeholder="Emergency Number 1" />
                                        <label for="argentNumber1">Emergency Number 1</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="tel" id="argentNumber2" formControlName="argentNumber2"
                                            class="form-control" placeholder="Emergency Number 2" />
                                        <label for="argentNumber2">Emergency Number 2</label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-floating">
                                        <input type="text" id="address" formControlName="address" class="form-control"
                                            placeholder="Address" />
                                        <label for="address">Address</label>
                                    </div>
                                </div>
                                <div class="col-6  mb-3">
                                    <label for="nationalIDImage" class="form-label">National ID Image</label>
                                    <input type="file" formControlName="nationalIDImage" class="form-control"
                                        accept="image/*" (change)="onImageUpload($event , 'nationalIDImage')">
                                    @if(addNewUserForm.get('employeeData.nationalIDImage')?.value){
                                    <div>
                                        <img [src]="imgUrl + addNewUserForm.get('employeeData.nationalIDImage')?.value"
                                            alt="Preview" class="mt-2 img-thumbnail"
                                            style="width: 120px; height: 120px; object-fit: cover;">
                                    </div>
                                    }
                                </div>
                                <div class="col-6  mb-3">
                                    <label for="birthstatementImage" class="form-label">Birth Statement Image</label>
                                    <input type="file" formControlName="birthstatementImage" class="form-control"
                                        accept="image/*" (change)="onImageUpload($event , 'birthstatementImage')">
                                    @if(addNewUserForm.get('employeeData.birthstatementImage')?.value){
                                    <div>
                                        <img [src]="imgUrl + addNewUserForm.get('employeeData.birthstatementImage')?.value"
                                            alt="Preview" class="mt-2 img-thumbnail"
                                            style="width: 120px; height: 120px; object-fit: cover;">
                                    </div>
                                    }

                                </div>
                                <div class="col-6  mb-3">
                                    <label for="civilStatusStatemntImage" class="form-label">Civil Status Statement
                                        Image</label>
                                    <input type="file" formControlName="civilStatusStatemntImage" class="form-control"
                                        accept="image/*" (change)="onImageUpload($event , 'civilStatusStatemntImage')">

                                    @if(addNewUserForm.get('employeeData.civilStatusStatemntImage')?.value){
                                    <div>
                                        <img [src]="imgUrl + addNewUserForm.get('employeeData.civilStatusStatemntImage')?.value"
                                            alt="Preview" class="mt-2 img-thumbnail"
                                            style="width: 120px; height: 120px; object-fit: cover;">
                                    </div>
                                    }
                                </div>
                                <div class="col-6  mb-3">
                                    <label for="educationalqualificationImage" class="form-label">Educational
                                        Qualification Image</label>
                                    <input type="file" formControlName="educationalqualificationImage"
                                        class="form-control" accept="image/*"
                                        (change)="onImageUpload($event , 'educationalqualificationImage')">

                                    @if(addNewUserForm.get('employeeData.educationalqualificationImage')?.value){
                                    <div>
                                        <img [src]="imgUrl + addNewUserForm.get('employeeData.educationalqualificationImage')?.value"
                                            alt="Preview" class="mt-2 img-thumbnail"
                                            style="width: 120px; height: 120px; object-fit: cover;">
                                    </div>
                                    }
                                </div>
                                <div class="col-6  mb-3">
                                    <label for="malitaryStatusImage" class="form-label">
                                        Military Status Image</label>
                                    <input type="file" formControlName="malitaryStatusImage" class="form-control"
                                        accept="image/*" (change)="onImageUpload($event , 'malitaryStatusImage')">

                                    @if(addNewUserForm.get('employeeData.malitaryStatusImage')?.value){
                                    <div>
                                        <img [src]="imgUrl + addNewUserForm.get('employeeData.malitaryStatusImage')?.value"
                                            alt="Preview" class="mt-2 img-thumbnail"
                                            style="width: 120px; height: 120px; object-fit: cover;">
                                    </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="flex pt-4 justify-between">
                            <p-button label="Back" severity="secondary" icon="pi pi-arrow-left"
                                (onClick)="activateCallback(1)" />
                        </div>
                    </ng-template>
                </p-step-panel>


            </p-step-panels>
        </p-stepper>
    </form>
    }


    @else {
    <p class="text-center">Are you sure to deactivate the selected user</p>
    }

    <ng-template pTemplate="footer">
        <div class="flex flex-col gap-2 md:flex-row md:justify-end md:gap-4 w-full px-2 py-2">
            <p-button label="Cancel" [text]="true" severity="danger" (click)="hideDialog();" class="w-full md:w-auto" />
            <p-button label="Save" [disabled]="addNewUserForm.invalid" [outlined]="true" severity="success"
                (onClick)="isEdit ?  updateSelectedUser():addNewUser()" class="w-full md:w-auto" />
        </div>
    </ng-template>
</p-dialog>

<p-dialog [(visible)]="detailsDialog" [header]="'User Details'" [modal]="true" [style]="{width: '50vw'}">
    @if(selectedUser) {
    <div>
        <p><strong>Username:</strong> {{selectedUser.username}}</p>
        <p><strong>Name (AR):</strong> {{selectedUser.nameAr}}</p>
        <p><strong>Name (EN):</strong> {{selectedUser.nameEn}}</p>
        <p><strong>Email:</strong> {{selectedUser.email}}</p>
        <p><strong>Phone Number:</strong> {{selectedUser.phoneNumber}}</p>
        <!-- Add other details you want to show -->
    </div>
    }
</p-dialog>
<div class="flex flex-col gap-6">
    <!-- Patients Who Accepted Treatment Plan Report -->
    <p-accordion [activeIndex]="0">
        <p-card *ngIf="selectedPatient" class="block mb-4">
            <div class="flex justify-between items-center">
                <span class="text-xl font-bold text-green-700">Selected Patient: {{selectedPatient.name}}</span>
                <p-button label="Reset Selection" severity="secondary" icon="pi pi-refresh" (onClick)="resetSelection()" />
            </div>
        </p-card>

        <ng-container *ngFor="let patient of patients">
            <p-accordionTab *ngIf="!selectedPatient || selectedPatient.id === patient.id"
                [selected]="selectedPatient?.id === patient.id">
                <ng-template pTemplate="header">
                    <div class="flex align-items-center gap-2 w-full justify-content-between">
                        <div class="flex align-items-center gap-2">
                            <span class="font-bold white-space-nowrap">{{ patient.name }}</span>
                            <p-tag [value]="patient.status" [severity]="getSeverity(patient.status)" />
                            <p-tag *ngIf="patient.acceptedReport" value="✓ Accepted Report" severity="success" icon="pi pi-check" />
                            <p-tag *ngIf="!patient.acceptedReport" value="✗ Not Accepted" severity="danger" icon="pi pi-times" />
                        </div>
                    </div>
                </ng-template>

                <!-- Simplified View (When no patient is selected) -->
                <div *ngIf="!selectedPatient" class="flex flex-col gap-4 p-3">
                    <div class="flex justify-between items-center">
                        <span class="text-base text-gray-600">Name:</span>
                        <span class="text-base font-semibold">{{ patient.name }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-base text-gray-600">Appointment Date:</span>
                        <span class="text-base font-semibold">{{ patient.bookingDate }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-base text-gray-600">Gender:</span>
                        <span class="text-base font-semibold">{{ patient.gender }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-base text-gray-600">Injury:</span>
                        <span class="text-base font-semibold">{{ patient.injury }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-base text-gray-600">Activity (Sport):</span>
                        <span class="text-base font-semibold">{{ patient.sport }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-base text-gray-600">Injury Level:</span>
                        <div class="flex items-center gap-2">
                            <span class="text-base font-semibold">{{ patient.level }}</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-base text-gray-600">Report Status:</span>
                        <div class="flex items-center gap-2">
                            <p-tag *ngIf="patient.acceptedReport" value="Accepted" severity="success" icon="pi pi-check-circle" />
                            <p-tag *ngIf="!patient.acceptedReport" value="Not Accepted" severity="danger" icon="pi pi-times-circle" />
                        </div>
                    </div>

                    <div class="flex gap-2 ml-auto">
                        <p-button *ngIf="!selectedPatient" label="Add sessions" size="small" icon="pi pi-plus"
                            (onClick)="selectPatient(patient); $event.stopPropagation()" />
                        <p-tag *ngIf="selectedPatient?.id === patient.id" value="Selected" severity="success" />
                    </div>

                </div>

                <!-- Full Details View (When patient is selected) -->
                <div *ngIf="selectedPatient" class="flex flex-col gap-6 p-3">
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Patient ID:</span>
                        <span class="text-lg font-medium">{{ patient.id }}</span>
                    </div>
                    <!-- Adding new fields to full view as well for consistency if desired, or sticking to original set plus status -->
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Injury:</span>
                        <span class="text-lg font-medium">{{ patient.injury }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Sport:</span>
                        <span class="text-lg font-medium">{{ patient.sport }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Level:</span>
                        <p-tag [value]="patient.status" [severity]="getSeverity(patient.status)" />
                    </div>

                    <div class="flex justify-between items-center">
                        <span class="text-lg">Age:</span>
                        <span class="text-lg font-medium">{{ patient.age }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Gender:</span>
                        <span class="text-lg font-medium">{{ patient.gender }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Mobile:</span>
                        <span class="text-lg font-medium">{{ patient.mobile }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Email:</span>
                        <span class="text-lg font-medium">{{ patient.email }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Address:</span>
                        <span class="text-lg font-medium">{{ patient.address }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Booking Date:</span>
                        <span class="text-lg font-medium">{{ patient.bookingDate }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Service:</span>
                        <span class="text-lg font-medium">{{ patient.service }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Booking Time:</span>
                        <span class="text-lg font-medium">{{ patient.bookingTime }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-lg">Report Status:</span>
                        <p-tag *ngIf="patient.acceptedReport" value="Accepted" severity="success" icon="pi pi-check-circle" />
                        <p-tag *ngIf="!patient.acceptedReport" value="Not Accepted" severity="danger" icon="pi pi-times-circle" />
                    </div>
                </div>
            </p-accordionTab>
        </ng-container>
    </p-accordion>

    <!-- Treatment Phases Accordion -->
    <p-card *ngIf="selectedPatient && selectedPatient.reportPhases && selectedPatient.reportPhases.length > 0">
        <ng-template pTemplate="header">
            <div class="px-4 pt-4 pb-2">
                <h2 class="text-2xl font-bold text-gray-800 mb-1">Treatment Phases from Report</h2>
                <p class="text-gray-600 text-sm">Click on a phase to define sessions and sections</p>
            </div>
        </ng-template>

        <p-accordion>
            <p-accordionTab *ngFor="let phase of selectedPatient.reportPhases; let i = index">
                <ng-template pTemplate="header">
                    <div class="flex justify-between items-center w-full pr-4">
                        <span class="font-bold text-lg">{{phase.title}}</span>
                        <p-tag [value]="'Phase ' + (phase.id || i+1)" severity="warn"></p-tag>
                    </div>
                </ng-template>

                <!-- Accordion Body -->
                <div class="flex flex-col gap-4">
                    <!-- Weeks and Sessions Per Week Inputs -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="font-medium text-sm text-gray-700">Weeks:</label>
                            <input pInputText type="number" [(ngModel)]="phase.weeksCount" 
                                   (ngModelChange)="updateTotalSessions(phase)"
                                   placeholder="eg., 12" class="w-full" />
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="font-medium text-sm text-gray-700">Sessions per week:</label>
                            <input pInputText type="number" [(ngModel)]="phase.sessionsPerWeek" 
                                   (ngModelChange)="updateTotalSessions(phase)"
                                   placeholder="eg., 12" class="w-full" />
                        </div>
                    </div>

                    <!-- All Weeks with Session Tabs -->
                    <div *ngIf="phase.weeksCount && phase.sessionsPerWeek" class="flex flex-col gap-6">
                        <!-- Loop through each week -->
                        <div *ngFor="let weekNum of getWeeksRange(phase.weeksCount)" class="border rounded-lg p-4 bg-gray-50">
                            <h3 class="font-bold text-lg mb-4">Week #{{weekNum}}</h3>

                            <!-- Session Tabs for this week -->
                            <div class="flex flex-wrap gap-2 mb-4">
                                <button *ngFor="let sessionInWeek of getSessionsRange(phase.sessionsPerWeek)"
                                        [class]="'px-6 py-2.5 rounded-lg font-medium text-base transition-all ' + 
                                                 (phase.selectedSessionTab === sessionInWeek ? 'bg-blue-600 text-white' : 'text-blue-600')"
                                        (click)="selectSessionTab(phase, sessionInWeek)">
                                    Session {{sessionInWeek}}
                                </button>
                            </div>

                            <!-- Selected Session Content for this week -->
                            <div *ngIf="phase.selectedSessionTab">
                                <!-- Calculate global session number -->
                                <ng-container *ngIf="getSessionNumber(weekNum, phase.selectedSessionTab, phase.sessionsPerWeek) as globalSessionNum">
                                    <!-- Sections for this session in this week -->
                                    <div class="flex flex-col gap-4">
                                        <div *ngFor="let section of getSections(phase, globalSessionNum); let secIndex = index" 
                                             class="border border-gray-300 rounded-lg p-4 bg-white">
                                            
                                            <!-- Section Header with Number Badge and Delete Button -->
                                            <div class="flex items-center justify-between mb-4">
                                                <div class="flex items-center gap-3">
                                                    <div class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-400 text-white font-bold">
                                                        {{secIndex + 1}}
                                                    </div>
                                                    <span class="font-medium text-lg">{{section.title || 'Section ' + (secIndex + 1)}}</span>
                                                </div>
                                                <button pButton icon="pi pi-trash" 
                                                        class="p-button-text p-button-danger p-button-sm" 
                                                        (click)="removeSection(phase, globalSessionNum, secIndex)"></button>
                                            </div>

                                            <!-- Section Configuration -->
                                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                           
                                                <div class="flex flex-col gap-2">
                                                    <label class="font-medium text-sm text-gray-600">Time</label>
                                                    <input pInputText type="number" [(ngModel)]="section.time" placeholder="e.g. 10" />
                                                </div>
                                                <div class="flex flex-col gap-2">
                                                    <label class="font-medium text-sm text-gray-600"> Coach</label>
                                                    <p-dropdown [options]="coaches" [(ngModel)]="section.coach" 
                                                               placeholder="Select Coach" styleClass="w-full" 
                                                               optionLabel="label" optionValue="value"></p-dropdown>
                                                </div>
                                            </div>

                                            <!-- Exercises Table -->
                                            <div class="bg-white rounded border border-gray-200 overflow-hidden">
                                                <p-table [value]="section.exercises" styleClass="p-datatable-sm">
                                                    <ng-template pTemplate="header">
                                                        <tr>
                                                            <th style="width: 3%"></th>
                                                            <th style="width: 12%">Name</th>
                                                            <th style="width: 18%">Description</th>
                                                            <th style="width: 8%">Sets</th>
                                                            <th style="width: 8%">Reps</th>
                                                            <th style="width: 10%">Intensity</th>
                                                            <th style="width: 8%">Tempo</th>
                                                            <th style="width: 10%">Rest</th>
                                                            <th style="width: 18%">Video URL</th>
                                                            <th style="width: 5%"></th>
                                                        </tr>
                                                    </ng-template>
                                                    <ng-template pTemplate="body" let-ex let-exIndex="rowIndex">
                                                        <tr [pReorderableRow]="exIndex">
                                                            <td>
                                                                <span class="pi pi-bars" 
                                                                      pReorderableRowHandle 
                                                                      pTooltip="Drag to reorder exercises" 
                                                                      tooltipPosition="top"
                                                                      style="cursor: move; color: #6b7280;"></span>
                                                            </td>
                                                            <td>
                                                                <input pInputText [(ngModel)]="ex.name" 
                                                                       class="w-full p-inputtext-sm" 
                                                                       placeholder="Exercise name" />
                                                            </td>
                                                            <td>
                                                                <textarea pInputTextarea [(ngModel)]="ex.description" 
                                                                         rows="2" 
                                                                         class="w-full p-inputtext-sm" 
                                                                         placeholder="Description"></textarea>
                                                            </td>
                                                            <td>
                                                                <input pInputText [(ngModel)]="ex.sets" 
                                                                       class="w-full p-inputtext-sm" 
                                                                       placeholder="3" />
                                                            </td>
                                                            <td>
                                                                <input pInputText [(ngModel)]="ex.reps" 
                                                                       class="w-full p-inputtext-sm" 
                                                                       placeholder="10" />
                                                            </td>
                                                            <td>
                                                                <input pInputText [(ngModel)]="ex.intensity" 
                                                                       class="w-full p-inputtext-sm" 
                                                                       placeholder="Moderate" />
                                                            </td>
                                                            <td>
                                                                <input pInputText [(ngModel)]="ex.tempo" 
                                                                       class="w-full p-inputtext-sm" 
                                                                       placeholder="2-0-2" />
                                                            </td>
                                                            <td>
                                                                <input pInputText [(ngModel)]="ex.rest" 
                                                                       class="w-full p-inputtext-sm" 
                                                                       placeholder="60s" />
                                                            </td>
                                                            <td>
                                                                <input pInputText [(ngModel)]="ex.videoUrl" 
                                                                       class="w-full p-inputtext-sm" 
                                                                       placeholder="Video URL" />
                                                            </td>
                                                            <td>
                                                                <button pButton icon="pi pi-trash" 
                                                                        class="p-button-text p-button-danger p-button-sm" 
                                                                        (click)="removeExercise(section, exIndex)"></button>
                                                            </td>
                                                        </tr>
                                                    </ng-template>
                                                </p-table>
                                                <div class="p-2 border-t bg-gray-50">
                                                    <p-button label="Add Exercise" [text]="true" size="small" 
                                                             icon="pi pi-plus" (onClick)="addExercise(section)"></p-button>
                                                </div>
                                            </div>

                                            <!-- Section Action Buttons -->
                                            <div class="flex justify-end gap-3 mt-4">
                                                <p-button label="Cancel" 
                                                         [outlined]="true" 
                                                         severity="secondary"
                                                         size="small"></p-button>
                                                <p-button label="Save" 
                                                         severity="success"
                                                         size="small"></p-button>
                                            </div>
                                        </div>

                                        <!-- Add Section Button for this week's session -->
                                        <div class="flex justify-center">
                                            <p-button label="Add New Section" icon="pi pi-plus-circle" 
                                                     severity="secondary" [outlined]="true" 
                                                     (onClick)="addSection(phase, globalSessionNum)"></p-button>
                                        </div>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </div>

                    <!-- No Sessions Message -->
                    <div *ngIf="!phase.weeksCount || !phase.sessionsPerWeek" 
                         class="flex flex-col items-center justify-center p-8 text-gray-400 border-2 border-dashed rounded-xl">
                        <i class="pi pi-info-circle text-3xl mb-2"></i>
                        <span class="text-center">Enter weeks and sessions per week to configure sessions</span>
                    </div>
                </div>
            </p-accordionTab>
        </p-accordion>
    </p-card>
</div>

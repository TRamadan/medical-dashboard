<p-toast />
<form [formGroup]="workingHoursForm">
    @if (!isEdit) {
    <div class="mb-3 d-flex align-items-center gap-2 p-3 surface-50 border-round">
        <p-checkbox binary="true" [ngModelOptions]="{ standalone: true }" [(ngModel)]="applyToAllDays"
            inputId="applyToAllDays" (onChange)="onApplyToAllChange()"> </p-checkbox>
        <label for="applyToAllDays" class="ml-2 font-medium cursor-pointer">Apply selected times to all days</label>
    </div>
    }

    <p-accordion value="0">
        <div formArrayName="days">
            @for (day of weekDays; track day; let dayIndex = $index) {
            @if (!isEdit || (isEdit && day.value == selectedDayOfWeek)) {
            <p-accordion-panel [value]="dayIndex.toString()" [formGroupName]="dayIndex">
                <p-accordion-header>{{ day.label }}</p-accordion-header>
                <p-accordion-content>
                    <div formArrayName="workingHours">
                        @for (workingHour of getDayWorkingHoursArray(dayIndex).controls; track workingHour; let
                        workingHourIndex = $index) {
                        <div class="card p-3 mb-3 border-0 shadow-sm surface-card border-round"
                            [formGroupName]="workingHourIndex">
                            <div class="row g-3 align-items-end">
                                <!-- Start Time -->
                                <div class="col-12 col-md-5">
                                    <label [for]="'start-' + dayIndex + '-' + workingHourIndex"
                                        class="block font-medium mb-1"> Start time </label>
                                    <p-select appendTo="body" formControlName="startTime"
                                        [inputId]="'start-' + dayIndex + '-' + workingHourIndex"
                                        [options]="durationOptions" optionLabel="label" optionValue="value"
                                        placeholder="Select start time" styleClass="w-full"
                                        (onChange)="onTimeChanged(dayIndex, workingHourIndex)">
                                    </p-select>

                                    @if (getWorkingHourFormGroup(dayIndex, workingHourIndex).get('startTime')?.invalid
                                    && getWorkingHourFormGroup(dayIndex, workingHourIndex).get('startTime')?.touched) {
                                    <small class="text-red-500 mt-1 block">Start time is required</small>
                                    }
                                </div>

                                <!-- End Time -->
                                <div class="col-12 col-md-5">
                                    <label [for]="'end-' + dayIndex + '-' + workingHourIndex"
                                        class="block font-medium mb-1"> End time </label>
                                    <p-select appendTo="body" formControlName="endTime"
                                        [inputId]="'end-' + dayIndex + '-' + workingHourIndex"
                                        [options]="durationOptions" optionLabel="label" optionValue="value"
                                        placeholder="Select end time" styleClass="w-full"
                                        (onChange)="onTimeChanged(dayIndex, workingHourIndex)">
                                    </p-select>

                                    @if (getWorkingHourFormGroup(dayIndex, workingHourIndex).get('endTime')?.invalid &&
                                    getWorkingHourFormGroup(dayIndex, workingHourIndex).get('endTime')?.touched) {
                                    <small class="text-red-500 mt-1 block">End time is required</small>
                                    }
                                </div>

                                <!-- Remove Button -->
                                <div class="col-12 col-md-2 text-end">
                                    @if (getDayWorkingHoursArray(dayIndex).length > 0) {
                                    <p-button icon="pi pi-trash" [text]="true" severity="danger"
                                        (onClick)="removeWorkingHour(dayIndex, workingHourIndex)"
                                        pTooltip="Remove slot" />
                                    }
                                </div>

                                <!-- Group-level error -->
                                @if (getWorkingHourFormGroup(dayIndex, workingHourIndex).errors?.['startAfterEnd'] &&
                                getWorkingHourFormGroup(dayIndex, workingHourIndex).touched) {
                                <div class="col-12 mt-1">
                                    <small class="text-red-500">Start time must be earlier than end time</small>
                                </div>
                                }
                            </div>
                        </div>
                        }

                        <!-- Show message when no working hours exist for this day -->
                        @if (getDayWorkingHoursArray(dayIndex).length === 0) {
                        <div class="flex flex-col items-center justify-center py-4 text-center">
                            <i class="pi pi-calendar-times text-2xl mb-2 text-gray-400"></i>
                            <div class="text-gray-500 italic">No working hours added for {{ day.label }}</div>
                        </div>
                        }
                    </div>

                    <!-- Add new working hour button for specific day -->
                    <p-button label="Add Working Hour" icon="pi pi-plus" [outlined]="true" severity="primary"
                        styleClass="w-full mt-2" (onClick)="addWorkingHour(dayIndex)" />
                </p-accordion-content>
            </p-accordion-panel>
            }
            }
        </div>
    </p-accordion>
</form>
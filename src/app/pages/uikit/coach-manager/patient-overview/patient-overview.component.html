<div class="flex flex-col gap-6 mb-6">
    <p-accordion [value]="selectedPatient?.id">
        @if (selectedPatient) {
        <p-card class="block mb-4">
            <div class="flex justify-between items-center">
                <span class="text-xl font-bold text-green-700">Selected Patient: {{selectedPatient.name}}</span>
                <p-button label="Reset Selection" severity="secondary" icon="pi pi-refresh"
                    (onClick)="resetSelection()" />
            </div>
        </p-card>
        }
        @for (patient of patients; track patient) {
        <p-accordion-panel [value]="patient.id">
            <!-- HEADER -->
            <p-accordion-header>
                <div class="flex align-items-center gap-2 w-full justify-content-between">
                    <div class="flex align-items-center gap-2">
                        @if (patient.acceptedReport) {
                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-green-500"
                            pTooltip="Report Accepted" tooltipPosition="top">
                            <i class="pi pi-check text-white text-sm"></i>
                        </div>

                        } @else {
                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-300"
                            pTooltip="Report Pending" tooltipPosition="top">
                            <i class="pi pi-clock text-white text-sm"></i>
                        </div>
                        }

                        <span class="font-bold white-space-nowrap">
                            {{ patient.name }}
                        </span>

                        <p-tag [value]="patient.status" [severity]="getSeverity(patient.status)"> </p-tag>

                        @if (patient.acceptedReport) {
                        <p-tag value="✓ Accepted Report" severity="success" icon="pi pi-check"> </p-tag>
                        } @else {
                        <p-tag value="✗ Not Accepted" severity="danger" icon="pi pi-times"></p-tag>
                        }
                    </div>
                </div>
            </p-accordion-header>

            <!-- CONTENT -->
            <p-accordion-content>
                <div class="card shadow-sm patient-info border-none">
                    <div class="card-body">
                        @if (!selectedPatient) {
                        <div class="d-flex align-items-center mb-3">
                            <svg class="icon me-2" viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                            </svg>
                            <h2 class="h5 mb-0 fw-semibold">Patient Information</h2>
                        </div>
                        <div class="flex flex-col gap-4 p-3">
                            <div class="flex justify-between items-center">
                                <span class="text-base text-gray-600">Name:</span>
                                <span class="text-base font-semibold">{{ patient.name }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-base text-gray-600">Appointment Date:</span>
                                <span class="text-base font-semibold">{{ patient.bookingDate }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-base text-gray-600">Gender:</span>
                                <span class="text-base font-semibold">{{ patient.gender }}</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-base text-gray-600">Injury:</span>
                                <span class="text-base font-semibold">{{ patient.injury }}</span>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="text-base text-gray-600">Report Status:</span>
                                <div class="flex items-center gap-2">
                                    @if (patient.acceptedReport) {
                                    <p-tag value="Accepted" severity="success" icon="pi pi-check-circle" />
                                    }
                                    @if (!patient.acceptedReport) {
                                    <p-tag value="Not Accepted" severity="danger" icon="pi pi-times-circle" />
                                    }
                                </div>
                            </div>

                            <div class="flex gap-2 ml-auto">
                                @if (!selectedPatient) {
                                <p-button label="Select Patient" size="small" icon="pi pi-check"
                                    (onClick)="selectPatient(patient); $event.stopPropagation()" />
                                }
                                @if (selectedPatient?.id === patient.id) {
                                <p-tag value="Selected" severity="success" />
                                }
                            </div>
                        </div>
                        }
                    </div>
                </div>

                <!-- here is the card needed for the treatment plan based on the selected patient-->
                <div class="card shadow-sm patient-info border-none">
                    <div class="d-flex align-items-center mb-3">
                        <svg class="icon me-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"></path>
                            <path d="M14 2v4a2 2 0 0 0 2 2h4"></path>
                            <path d="M10 9H8"></path>
                            <path d="M16 13H8"></path>
                            <path d="M16 17H8"></path>
                        </svg>
                        <h2 class="h5 mb-0 fw-semibold">Plan Details</h2>
                    </div>
                    <div class="flex flex-col gap-4 p-3">
                        <div class="flex justify-between items-center">
                            <span class="text-base text-gray-600">Plan ID:</span>
                            <span class="text-base font-semibold">{{ patient.treatmentPlan.planId }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-base text-gray-600">Created By:</span>
                            <span class="text-base font-semibold">{{ patient.treatmentPlan.createdBy }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-base text-gray-600">Assigned Date:</span>
                            <span class="text-base font-semibold">{{ patient.treatmentPlan.assignedDate }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-base text-gray-600">Patient Approval:</span>
                            <span class="text-base font-semibold">{{ patient.treatmentPlan.patientApproval }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-base text-gray-600">Approval Date:</span>
                            <span class="text-base font-semibold">{{ patient.treatmentPlan.approvalDate }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-base text-gray-600">Duration:</span>
                            <span class="text-base font-semibold">{{ patient.treatmentPlan.durationWeeks }}
                                <strong>weeks</strong></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-base text-gray-600">Sessions:</span>
                            <span class="text-base font-semibold">{{ patient.treatmentPlan.totalSessions }} total
                                <strong>({{patient.treatmentPlan.sessionsPerWeek}}x/week)</strong></span>
                        </div>
                    </div>



                </div>

                <!-- here is the card needed for to show the phases for the treatment plan-->
                <div class="card shadow-sm patient-info border-none">
                    <div class="container my-4">
                        <h3 class="mb-4">Treatment Phases Overview</h3>

                        @for(phase of patient?.treatmentPlan?.phases; track phase; let i = $index){
                        <div class="card mb-3 shadow-sm">
                            <div class="row g-0 align-items-center p-3">

                                <!-- Phase Number Badge -->
                                <div class="col-auto">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                        style="width: 40px; height: 40px; font-weight: bold;">
                                        {{ i + 1 }}
                                    </div>
                                </div>

                                <!-- Phase Info -->
                                <div class="col ms-3">
                                    <h5 class="mb-1">{{ phase.phase }}</h5>
                                    <small class="text-muted">Weeks {{ phase.weeks }} • Sessions {{ phase.sessions
                                        }}</small>
                                </div>

                                <!-- Specializations -->
                                <div class="col-auto text-end d-flex flex-wrap gap-1">
                                    <span class="text-muted me-2">Required Specializations:</span>
                                    <ng-container *ngFor="let spec of phase.specializations">
                                        <span class="badge bg-primary">{{ spec }}</span>
                                    </ng-container>
                                </div>

                            </div>
                        </div>
                        }
                    </div>

                </div>


                <!-- Simplified View (When no patient is selected) -->

            </p-accordion-content>
        </p-accordion-panel>
        }
    </p-accordion>
</div>